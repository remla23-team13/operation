# Operation
This repo contains all the files necessary to run the restaurant review assessment [application](https://github.com/remla23-team13/app).  
The app serves a website where one can enter some text to see whether it has a positive or negative sentiment.
The repo uses the images generated by other projects in the organisation, namely [model-service](https://github.com/remla23-team13/model-service).
There is also already scaffolding in-place for the app to make use of a library, which is located at [lib](https://github.com/remla23-team13/lib).
This is accomplished via a REST request to the model-service. 
Finally, there is the [model-training](https://github.com/remla23-team13/model-training) repository which will take care of the model training later.

The code base can be tested in different ways, with the Helm version having the most up-to-date code. 
It is also possible to only use Kubernetes or even only Docker-compose, both of these set-ups make use of older images, however. 
For the exact steps see the set-up guide. 

Once the webapp is accessible you can enter a sentence or word and the application will return the sentiment.
Important note: good is actually classified as having a negative sentiment, try great instead. 


## Set-up guide
#### Prerequisites
- Minikube v1.30
  - Docker driver is used
  - Ingress is enabled: ```minikube addons enable ingress```
- Helm v3.11
- Docker v20.10
- Docker Compose v2.4

First clone the project:
```bash
git clone git@github.com:remla23-team13/operation.git
cd operation
```

### Helm

Run ```minikube start```.
Make sure dependencies are installed:
```bash
helm dependency update ./charts
```

Install the services using helm:
```bash
helm install <RELEASE_NAME> ./charts
```
The `RELEASE_NAME` variable can be any string.

To access the application via the browser:
- MacOS: run ```minikube tunnel```. Leave that terminal window open, you can now access the app on localhost.
- Otherwise: run minikube service list. And use the URL of the ingress-nginx-controller.

To access the different endpoints use: 
- Webapp: ```http://localhost```
- Prometheus: ```http://localhost/prometheus/graph```
- Grafana: ```http://localhost/grafana```

For Grafana you can use the following default login credentials:
- user: admin
- password: prom-operator

To stop Helm use:
```bash
helm uninstall <RELEASE_NAME>
```

### Istio
For testing purposes it is also possible to deploy the app using Istio.


### prerequisites
- [istioctl](https://istio.io/latest/docs/setup/install/istioctl/) installed
- [Istio v1.17.2.](https://github.com/istio/istio/releases/tag/1.17.2) release downloaded in same folder as repository

Make sure you start minikube with enough resources, otherwise the application may not function. 
Then run the scripts, the first will install Istio onto your minikube cluster in addition to some nice addons. 
The second will apply the needed kubernetes files. 
```bash
minikube start --memory=10000 --cpus=4
./setup_istio.sh
./deploy_istio.sh
```

Run ```./delete_istio.sh``` to remove the webapp and the istio addons. 
This does not uninstall the istioctl installation or remove the istio enabled label. 

#### Continuous Experimentation
The Istio setup also allows us to live test two different versions of the system. We hope to verify that the background colour of the webapp affects the users' sentiments and reviews. In order to achieve this, we track the positive prediction ratio of each version, to determine if a significant difference exists.

### Kubernetes
Then run the following commands:
```bash
minikube start
minikube addons enable ingress
./deploy_kub.sh
```
Use ```kubectl get pods``` to verify that all pods have started.
To access the application via the browser:
- MacOS: run ```minikube tunnel```. Leave that terminal window open, you can now access the app on localhost.
- Otherwise: run minikube service list. And use the URL of the ingress-nginx-controller. 

You can use ```./delete_kub.sh``` to stop all kubernetes resources and ```stop Minikube``` to stop the cluster.
If you were wondering why we our model-service has been added to the ingress, this has to do with how React handles requests.

### Docker-Compose
**_NOTE:_** This version users an older image of the webapp and model-service.
Run the following commands in the root directory of this repo
```bash
docker compose up
```

To stop the containers use ```docker compose down```.
